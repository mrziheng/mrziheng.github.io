{{ define "main" }}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ .Title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        #map { height: 90vh; }
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    {{ .Content }}
    <div class="legend" id="legend"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script>
        // 初始化地图
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 颜色比例尺
        var colorScale = chroma.scale(['#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#bd0026','#800026']);

        // 获取数据
        fetch('/data/global-grid.geojson')
            .then(response => response.json())
            .then(data => {
                // 获取属性值范围
                var values = data.features.map(f => f.properties.value);
                var minValue = Math.min(...values);
                var maxValue = Math.max(...values);

                // 创建样式函数
                function getStyle(feature) {
                    return {
                        weight: 1,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.7,
                        fillColor: colorScale((feature.properties.value - minValue) / (maxValue - minValue))
                    };
                }

                // 创建图例
                createLegend(minValue, maxValue);

                // 添加GeoJSON数据
                L.geoJSON(data, {
                    style: getStyle,
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(`<b>值:</b> ${feature.properties.value}`);
                    }
                }).addTo(map);
            });

        // 创建图例
        function createLegend(min, max) {
            var legend = L.control({position: 'bottomleft'});
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                var grades = [min, (min+max)/2, max];
                var labels = [];
                
                // 添加渐变背景
                div.innerHTML = '<div style="height: 10px; background: linear-gradient(to right, '+colorScale(0)+' , '+colorScale(1)+'); margin-bottom: 5px;"></div>';
                
                // 添加数值标签
                grades.forEach(function(grade, i) {
                    labels.push(
                        '<span style="background:' + colorScale(i/(grades.length-1)) + '"> '+ 
                        grade.toFixed(2) + '</span>'
                    );
                });
                div.innerHTML += labels.join('<br>');
                return div;
            };
            legend.addTo(map);
        }
    </script>
</body>
</html>
{{ end }}