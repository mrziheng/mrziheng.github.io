{{ define "main" }}
<div id="map" style="width: 100%; height: 90vh;"></div>

<!-- 引入 Leaflet 地图库 -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- 引入 Chroma.js 颜色库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.2/chroma.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // 获取页面参数
    const geojsonFile = "{{ .Params.geojson_file }}";
    const valueField = "{{ .Params.value_field }}";
    const zoomLevel = {{ .Params.zoom_level | default 2 }};
    const centerLat = {{ .Params.center_lat | default 20 }};
    const centerLng = {{ .Params.center_lng | default 0 }};
    const colorScheme = "{{ .Params.color_scheme | default "#eafff5,#006400" }}";

    // 初始化地图
    const map = L.map('map').setView([centerLat, centerLng], zoomLevel);

    // 添加 OpenStreetMap 底图
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap 贡献者'
    }).addTo(map);

    // 解析颜色方案
    const colorRange = colorScheme.split(",").map(c => c.trim());

    // 动态加载 GeoJSON 数据
    fetch(`/data/${geojsonFile}`)
        .then(response => response.json())
        .then(data => {
            // 提取字段值范围
            const values = data.features
                .filter(f => f.properties[valueField] !== undefined)
                .map(f => parseFloat(f.properties[valueField]));

            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);

            // 创建颜色比例尺
            const colorScale = chroma.scale(colorRange).domain([minValue, maxValue]);

            // GeoJSON 样式配置
            const geoJsonStyle = {
                weight: 0.5,
                opacity: 1,
                color: '#333',
                fillOpacity: 0.8,
                fillColor: '#ccc',
                // 根据字段值动态设置颜色
                style: function (feature) {
                    return {
                        fillColor: colorScale(feature.properties[valueField]).hex(),
                        fillOpacity: 0.8
                    };
                },
                // 悬停和点击交互
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties[valueField]) {
                        // 绑定弹出框
                        layer.bindPopup(`
                            <strong>${feature.properties.name || "区域"}</strong><br>
                            ${valueField}: ${feature.properties[valueField]}
                        `);

                        // 悬停效果
                        layer.on({
                            mouseover: () => {
                                layer.setStyle({ weight: 2, color: '#000' });
                            },
                            mouseout: () => {
                                layer.setStyle({ weight: 0.5, color: '#333' });
                            }
                        });
                    }
                }
            };

            // 加载 GeoJSON 图层
            const geoJsonLayer = L.geoJson(data, geoJsonStyle).addTo(map);

            // 自动缩放至数据范围（如果 GeoJSON 包含 bbox）
            if (data.bbox) {
                map.fitBounds(L.latLngBounds(
                    [data.bbox[1], data.bbox[0]],
                    [data.bbox[3], data.bbox[2]]
                ));
            }
        })
        .catch(error => console.error('加载 GeoJSON 失败:', error));
});
</script>
{{ end }}